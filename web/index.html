<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>进销存系统</title>
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Microsoft YaHei', sans-serif; margin: 0; background: #f5f7fa; }
      header { background: #1677ff; color: #fff; padding: 12px 20px; }
      .container { padding: 16px; max-width: 1100px; margin: 0 auto; }
      .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
      .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
      input, select, button { padding: 8px; border-radius: 6px; border: 1px solid #d1d5db; }
      button { background: #1677ff; color: #fff; border: none; cursor: pointer; }
      button.secondary { background: #f5f5f5; color: #333; border: 1px solid #ddd; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
      .tabs { display: flex; gap: 8px; margin-bottom: 12px; }
      .tabs button { background: #fff; color: #333; border: 1px solid #ddd; }
      .tabs button.active { background: #1677ff; color: #fff; }
      .empty { color: #999; padding: 24px; text-align: center; }
      .print-area { background: #fff; padding: 16px; }
    </style>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body>
    <header>
      <h2>进销存系统</h2>
    </header>
    <div id="root" class="container"></div>

    <script type="text/babel">
      const API = 'http://127.0.0.1:8000';
      const fetchJSON = async (url, options={}) => {
        const token = localStorage.getItem('token');
        const headers = { 'Content-Type': 'application/json', ...(token ? { Authorization: `Bearer ${token}` } : {}) };
        const res = await fetch(url, { ...options, headers: { ...headers, ...(options.headers||{}) } });
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      };

      const Login = ({ onLogin }) => {
        const [username, setUsername] = React.useState('admin');
        const [password, setPassword] = React.useState('admin');
        const [error, setError] = React.useState('');
        const submit = async (e) => {
          e.preventDefault(); setError('');
          const form = new URLSearchParams({ username, password, grant_type: 'password' });
          const res = await fetch(`${API}/auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form });
          if (!res.ok) { setError('登录失败'); return; }
          const data = await res.json(); localStorage.setItem('token', data.access_token); onLogin();
        };
        return (
          <div className="card">
            <h3>用户登录</h3>
            {error && <div style={{color:'red'}}>{error}</div>}
            <form onSubmit={submit} className="row">
              <input placeholder="用户名" value={username} onChange={e=>setUsername(e.target.value)} />
              <input type="password" placeholder="密码" value={password} onChange={e=>setPassword(e.target.value)} />
              <button type="submit">登录</button>
            </form>
          </div>
        );
      };

      const Products = () => {
        const [items, setItems] = React.useState([]);
        const [form, setForm] = React.useState({ name:'', sku:'', price:0, stock:0, description:'' });
        const [editing, setEditing] = React.useState(null);
        const load = async () => setItems(await fetchJSON(`${API}/products/`));
        React.useEffect(()=>{ load(); },[]);
        const submit = async () => {
          if (editing) {
            await fetchJSON(`${API}/products/${editing.id}`, { method: 'PUT', body: JSON.stringify(form) });
          } else {
            await fetchJSON(`${API}/products/`, { method: 'POST', body: JSON.stringify(form) });
          }
          setForm({ name:'', sku:'', price:0, stock:0, description:'' }); setEditing(null); await load();
        };
        const del = async (id) => { await fetchJSON(`${API}/products/${id}`, { method:'DELETE' }); await load(); };
        return (
          <div className="card">
            <h3>商品管理</h3>
            <div className="row">
              <input placeholder="名称" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} />
              <input placeholder="SKU" value={form.sku} onChange={e=>setForm({...form, sku:e.target.value})} />
              <input type="number" placeholder="价格" value={form.price} onChange={e=>setForm({...form, price:parseFloat(e.target.value||0)})} />
              <input type="number" placeholder="库存" value={form.stock} onChange={e=>setForm({...form, stock:parseInt(e.target.value||0)})} />
              <input placeholder="描述" value={form.description} onChange={e=>setForm({...form, description:e.target.value})} />
              <button onClick={submit}>{editing? '保存修改':'新增商品'}</button>
              {editing && <button className="secondary" onClick={()=>{setEditing(null); setForm({ name:'', sku:'', price:0, stock:0, description:'' });}}>取消编辑</button>}
            </div>
            {items.length===0 ? <div className="empty">暂无商品</div> : (
              <table>
                <thead><tr><th>ID</th><th>名称</th><th>SKU</th><th>价格</th><th>库存</th><th>操作</th></tr></thead>
                <tbody>
                  {items.map(p=> (
                    <tr key={p.id}>
                      <td>{p.id}</td><td>{p.name}</td><td>{p.sku}</td><td>{p.price}</td><td>{p.stock}</td>
                      <td>
                        <button className="secondary" onClick={()=>{setEditing(p); setForm({ name:p.name, sku:p.sku||'', price:p.price, stock:p.stock, description:p.description||'' });}}>编辑</button>
                        <button onClick={()=>del(p.id)} style={{marginLeft:8}}>删除</button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}
          </div>
        );
      };

      const Customers = () => {
        const [items, setItems] = React.useState([]);
        const [form, setForm] = React.useState({ name:'', phone:'', address:'' });
        const [editing, setEditing] = React.useState(null);
        const load = async () => setItems(await fetchJSON(`${API}/customers/`));
        React.useEffect(()=>{ load(); },[]);
        const submit = async () => {
          if (editing) {
            await fetchJSON(`${API}/customers/${editing.id}`, { method: 'PUT', body: JSON.stringify(form) });
          } else {
            await fetchJSON(`${API}/customers/`, { method: 'POST', body: JSON.stringify(form) });
          }
          setForm({ name:'', phone:'', address:'' }); setEditing(null); await load();
        };
        const del = async (id) => { await fetchJSON(`${API}/customers/${id}`, { method:'DELETE' }); await load(); };
        return (
          <div className="card">
            <h3>客户管理</h3>
            <div className="row">
              <input placeholder="姓名" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} />
              <input placeholder="电话" value={form.phone} onChange={e=>setForm({...form, phone:e.target.value})} />
              <input placeholder="地址" value={form.address} onChange={e=>setForm({...form, address:e.target.value})} />
              <button onClick={submit}>{editing? '保存修改':'新增客户'}</button>
              {editing && <button className="secondary" onClick={()=>{setEditing(null); setForm({ name:'', phone:'', address:'' });}}>取消编辑</button>}
            </div>
            {items.length===0 ? <div className="empty">暂无客户</div> : (
              <table>
                <thead><tr><th>ID</th><th>姓名</th><th>电话</th><th>地址</th><th>操作</th></tr></thead>
                <tbody>
                  {items.map(c=> (
                    <tr key={c.id}>
                      <td>{c.id}</td><td>{c.name}</td><td>{c.phone}</td><td>{c.address}</td>
                      <td>
                        <button className="secondary" onClick={()=>{setEditing(c); setForm({ name:c.name, phone:c.phone||'', address:c.address||'' });}}>编辑</button>
                        <button onClick={()=>del(c.id)} style={{marginLeft:8}}>删除</button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}
          </div>
        );
      };

      const Orders = () => {
        const [products, setProducts] = React.useState([]);
        const [customers, setCustomers] = React.useState([]);
        const [selectedItems, setSelectedItems] = React.useState([]);
        const [selectedCustomerId, setSelectedCustomerId] = React.useState('');
        const [customCustomer, setCustomCustomer] = React.useState({ name:'', phone:'', address:'' });
        const [createdOrder, setCreatedOrder] = React.useState(null);
        React.useEffect(()=> { (async()=>{ setProducts(await fetchJSON(`${API}/products/`)); setCustomers(await fetchJSON(`${API}/customers/`)); })(); }, []);
        const addItem = (p) => {
          const ex = selectedItems.find(i=>i.product_id===p.id);
          if (ex) setSelectedItems(selectedItems.map(i=> i.product_id===p.id ? { ...i, quantity: i.quantity+1 } : i));
          else setSelectedItems([...selectedItems, { product_id: p.id, name:p.name, price:p.price, quantity:1 }]);
        };
        const changeQty = (pid, qty) => setSelectedItems(selectedItems.map(i=> i.product_id===pid ? { ...i, quantity: Math.max(1, qty) } : i));
        const total = selectedItems.reduce((s,i)=> s + i.price * i.quantity, 0);
        const submit = async () => {
          const payload = {
            customer_id: selectedCustomerId ? Number(selectedCustomerId) : null,
            customer_name: customCustomer.name || undefined,
            customer_phone: customCustomer.phone || undefined,
            customer_address: customCustomer.address || undefined,
            items: selectedItems.map(i=> ({ product_id: i.product_id, quantity: i.quantity }))
          };
          const order = await fetchJSON(`${API}/orders/`, { method: 'POST', body: JSON.stringify(payload) });
          setCreatedOrder(order);
        };
        const printOrder = () => { window.print(); };
        return (
          <div className="card">
            <h3>订单管理</h3>
            <div className="row">
              <select value={selectedCustomerId} onChange={e=>setSelectedCustomerId(e.target.value)}>
                <option value="">选择客户（可选）</option>
                {customers.map(c=> <option key={c.id} value={c.id}>{c.name}</option>)}
              </select>
              <input placeholder="自定义客户姓名" value={customCustomer.name} onChange={e=>setCustomCustomer({...customCustomer, name:e.target.value})} />
              <input placeholder="电话" value={customCustomer.phone} onChange={e=>setCustomCustomer({...customCustomer, phone:e.target.value})} />
              <input placeholder="地址" value={customCustomer.address} onChange={e=>setCustomCustomer({...customCustomer, address:e.target.value})} />
            </div>
            <div className="row" style={{marginTop:12}}>
              {products.map(p=> (
                <button key={p.id} className="secondary" onClick={()=>addItem(p)}>{p.name} ¥{p.price}</button>
              ))}
            </div>
            <div className="card" style={{marginTop:12}}>
              <h4>已选商品</h4>
              {selectedItems.length===0 ? <div className="empty">暂无已选商品</div> : (
                <table>
                  <thead><tr><th>名称</th><th>单价</th><th>数量</th><th>小计</th></tr></thead>
                  <tbody>
                    {selectedItems.map(i=> (
                      <tr key={i.product_id}>
                        <td>{i.name}</td><td>¥{i.price}</td>
                        <td><input type="number" value={i.quantity} onChange={e=>changeQty(i.product_id, parseInt(e.target.value||1))} /></td>
                        <td>¥{(i.price*i.quantity).toFixed(2)}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              )}
              <div className="row" style={{justifyContent:'space-between', marginTop:8}}>
                <div>合计：<b>¥{total.toFixed(2)}</b></div>
                <div>
                  <button onClick={submit} disabled={selectedItems.length===0}>确认下单</button>
                </div>
              </div>
            </div>

            {createdOrder && (
              <div className="card print-area">
                <h4>订单预览（可打印）</h4>
                <div>订单号：{createdOrder.id}</div>
                <div>客户：{createdOrder.customer_name || '—'} 电话：{createdOrder.customer_phone || '—'} 地址：{createdOrder.customer_address || '—'}</div>
                <table style={{marginTop:8}}>
                  <thead><tr><th>商品</th><th>单价</th><th>数量</th><th>小计</th></tr></thead>
                  <tbody>
                    {createdOrder.items.map(it=> (
                      <tr key={it.id}><td>{it.product_name}</td><td>¥{it.unit_price}</td><td>{it.quantity}</td><td>¥{it.subtotal}</td></tr>
                    ))}
                  </tbody>
                </table>
                <div style={{marginTop:8}}>总计：<b>¥{createdOrder.total_amount}</b></div>
                <button style={{marginTop:8}} onClick={printOrder}>打印订单</button>
              </div>
            )}
          </div>
        );
      };

      const App = () => {
        const [authed, setAuthed] = React.useState(!!localStorage.getItem('token'));
        const [tab, setTab] = React.useState('products');
        if (!authed) return <Login onLogin={()=>setAuthed(true)} />;
        return (
          <>
            <div className="card row" style={{justifyContent:'space-between'}}>
              <div className="tabs">
                {['products','customers','orders'].map(t=> (
                  <button key={t} className={tab===t? 'active':''} onClick={()=>setTab(t)}>{t==='products'?'商品':'customers'===t?'客户':'订单'}</button>
                ))}
              </div>
              <div>
                <button className="secondary" onClick={()=>{localStorage.removeItem('token'); location.reload();}}>退出登录</button>
              </div>
            </div>
            {tab==='products' && <Products />}
            {tab==='customers' && <Customers />}
            {tab==='orders' && <Orders />}
          </>
        );
      };

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
  </html>

